version: 3

workflows:
  windows-workflow:
    plan:
      steps:
        - run: >
            powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "& {
              Write-Output 'Checking Terraform Version...';
              try {
                & 'C:\\Users\\SharkOps011\\Downloads\\terraform_1.11.0_windows_386\\terraform.exe' version;
              } catch {
                Write-Output 'Terraform version check failed, continuing...';
              }
              Write-Output 'Initializing Terraform...';
              & 'C:\\Users\\SharkOps011\\Downloads\\terraform_1.11.0_windows_386\\terraform.exe' init -input=false -upgrade;
              Write-Output 'Running Terraform Plan...';
              & 'C:\\Users\\SharkOps011\\Downloads\\terraform_1.11.0_windows_386\\terraform.exe' plan -out=tfplan;
            }"
    apply:
      steps:
        - run: >
            powershell.exe -ExecutionPolicy Bypass -NoProfile -Command "& {
              Write-Output 'Applying Terraform Plan...';
              & 'C:\\Users\\SharkOps011\\Downloads\\terraform_1.11.0_windows_386\\terraform.exe' apply -auto-approve tfplan;
            }"

projects:
  - name: terraform-setup-project
    dir: "terraform-atlantis"
    workflow: windows-workflow
    autoplan:
      when_modified: ["*.tf", "*.tfvars"]
      enabled: true
